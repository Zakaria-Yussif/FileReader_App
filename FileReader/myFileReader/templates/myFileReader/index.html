{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FileReader</title>
<link rel="icon" type="image/png" href="{% static 'image/zack.png' %}">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- App CSS -->
  <link rel="stylesheet" href="{% static 'css/styleg.css' %}" />
  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" />

  <!-- MathJax -->
  <script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>

  <style>
    /* Headings */
    h1 { color: #007bff; }

    /* Auth Cards */
    .login_forms,
    .register_forms {
      margin: 120px auto;
      text-align: center;
      width: 30%;
      background-color: #fff;
      padding: 10px;
      border-radius: 10px;
      border: 2px solid rgba(0, 123, 255, 0.37);
    }
    .register_forms { box-shadow: 2px 5px 6px 6px rgba(35, 35, 41, 0.1); }

    /* Form Styling */
    .forms { display: flex; flex-direction: column; justify-content: center; }
    .form-field { margin-bottom: 10px; text-align: center; color: gray; border: 2px solid blue; padding: 5px; }
    .form-field label { display: block; font-weight: bold; margin-bottom: 5px; color: gray; }
    .form-field input { width: 50% !important; padding: 8px; margin-top: 5px; border: 1px solid #ccc !important; border-radius: 4px; outline-color: rgba(0, 179, 164, 0.65); }

    /* Buttons */
    button { padding: 10px 15px; background-color: #007bff; color: #fff; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
    button:hover { background-color: #0056b3; }

    /* Login Header */
    #login_header { color: #007bff; position: absolute; margin-top: -29px; background-color: #f4f4f4; width: 100px; border-radius: 5px; z-index: 1; }

    /* Login Button */
    #login_button { margin-top: 10px; background-color: green; color: #fff; border: none; font-size: 15px; padding: 3px 5px; border-radius: 2px; }

    #upload_data { display: none; }

    /* Messages */
    .message-right {
      display: flex; align-self: flex-end; overflow-wrap: break-word; word-wrap: break-word; background-color: #f0f0f0; border-radius: 10px 10px 0 10px; padding: 5px; margin-left: auto; margin-bottom: 10px; text-align: left;
    }
    .message-left { opacity: 1 !important; transition: opacity 1s ease-in-out; text-align: left; }

    .body { display: grid; grid-template-columns: 20% 80%; height: 90vh; width: 100%; }

    #sidebarCollapse { height: 89vh; box-shadow: 0 3px 0 0 rgba(13, 5, 1, 0.1); border-bottom: 1px solid grey; display: flex; flex-direction: column; }

    /* Typing Animation */
    @keyframes typing { from { width: 0; } to { width: 100%; } }
    @keyframes blinkCaret { 50% { border-color: transparent; } }

    /* Ensure Visibility */
    .message.visible { opacity: 1; }

    @media (max-width: 1008px) {
      #form { min-width: 96vw ; margin-top:-20px}
      .body { grid-template-columns: 0% 100%; position: fixed; max-height: 89vh; }
      .form-control { min-width: 100%; }
      #sidebarCollapse { height: 20px; width: 0; visibility: hidden; overflow: hidden; }
      .main-container { width: 100%; }
      #button-group { margin-left: 100px; }
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg bg-body-white">
    <div class="container-fluid">
<a class="navbar-brand" href="#">
  <img src="{% static 'image/zack.png' %}"  class="img-fluid" style="max-height:50px; width: 50px">
</a>



      <!-- One toggler controls both nav and sidebar -->
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target=".dual-collapse" aria-controls="navbarCollapse sidebarCollapse" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse dual-collapse" id="navbarCollapse">
        <ul class="navbar-nav">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">Data Analysis</a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#">Action</a></li>
              <li><a class="dropdown-item" href="#">Another action</a></li>
              <li><a class="dropdown-item" href="#">Something else here</a></li>
            </ul>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">Data Visualisation</a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#">Action</a></li>
              <li><a class="dropdown-item" href="#">Another action</a></li>
              <li><a class="dropdown-item" href="#">Something else here</a></li>
            </ul>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">File Reader</a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#">Action</a></li>
              <li><a class="dropdown-item" href="#">Another action</a></li>
              <li><a class="dropdown-item" href="#">Something else here</a></li>
            </ul>
          </li>
          <li class="nav-item"><a class="nav-link" href="#">Logout</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="body">
    <!-- Sidebar -->
    <div id="sidebarCollapse" class="collapse bg-body-secondary text-center dual-collapse">
      <div style="height: 30vh;"><h6 class="text-muted">Data Analysis</h6></div>
      <div style="height: 30vh;"><h6 class="text-muted">Data Visualisation</h6></div>
      <div style="height: 30vh;"><h6 class="text-muted">FileReader</h6></div>
      <div><span class="text-muted small text-start"><span class="text-dark">Â©</span> 2025 Zack. All rights reserved</span></div>
    </div>

    <!-- Main -->
    <div class="w-100">
      <div class="main-container" style="height: 74vh; width: 99%; margin: 10px; overflow-y: auto; padding-right: 10px; cursor: default;">

        {% for item in messageData %}
          <div class="{% if item.id %}message-right{% else %}message-left{% endif %}"
               id="msg-{{ forloop.counter }}"
               style="{% if item.id %}
                 max-width: 40%; background-color: rgba(245,245,245,0.96); border-radius: 10px 10px 0 10px; padding: 5px; font-size: 17px; direction: rtl;
               {% else %}
                 max-width: 80%; box-shadow: 10px 5px 10px 10px rgba(255,255,255,0.1); font-size: 17px; color: #333; font-family: -apple-system, BlinkMacSystemFont, avenir next, avenir, segoe ui, helvetica neue, helvetica, Cantarell, Ubuntu, roboto, noto, arial, sans-serif; background-color: rgba(245,245,245,0.34);
               {% endif %}">

            <p class="message_display">{{ item.message }}</p>

            <!-- Per-card search spinner + results -->
            <span id="spinner-{{ forloop.counter }}" class="d-none">Searching ...</span>

            {% if item.website %}
              <div id="results-{{ forloop.counter }}" class="search_results">
                <div class="search-result mb-3">
                  {% comment %} Header (prefer mainHeader, else nHeader) {% endcomment %}
<p>{% firstof item.website.mainHeader item.website.nHeader '' %}</p>

                  {% if item.website.mainContent %}<p>{{ item.website.mainContent }}</p>{% endif %}
                  {% if item.website.complete %}<h2>{{ item.website.complete }}</h2>{% endif %}

                  {% if item.website.paragraph %}
                    <p><strong>ðŸ“– Content:</strong> {{ item.website.paragraph|join:" " }}</p>
                  {% endif %}

                  <h6>
                    <a href="{{ item.website.link }}" target="_blank" rel="noopener">{{ item.website.title }}</a>
                  </h6>
                  {% if item.website.snippet %}
                    <p class="text-muted">{{ item.website.snippet }}</p>
                  {% endif %}

                  {% if item.website.logo and item.website.logo != "No logo available" %}
                    <img id="image-{{ forloop.counter }}" src="{{ item.website.logo }}" alt="Website Logo" style="max-width: 100px; height: auto; border-radius: 5px;" />
                  {% endif %}
                </div>
              </div>
            {% endif %}

            {% if item.translated %}
              <div class="d-flex flex-column p-3 rounded shadow-sm mt-3">
                <ul class="list-unstyled mb-0">
                  <li><strong>{{ item.translated.message }}</strong></li>
                  <li>{{ item.translated.user_input }}</li>
                  <hr />
                  <li><strong>{{ item.translated.translator }}</strong></li>
                  <li>{{ item.translated.translator_text }}</li>
                </ul>
              </div>
            {% endif %}

            {% if item.weather %}
              <div class="rounded shadow-sm mt-3 p-2">
                <table class="table table-sm table-bordered w-50 m-2 bg-light">
                  <tr>
                    <th scope="col">Weather</th>
                    <th scope="col">Icon</th>
                    <th scope="col">Temperature</th>
                  </tr>
                  <tr>
                    <td>{{ item.weather.weather }}</td>
                    <td><img src="{{ item.weather.weather_icon }}" alt="weather icon" style="width: 50px;" /></td>
                    <td>{{ item.weather.weather_temperature }}</td>
                  </tr>
                </table>
                <p>
                  You are currently located in <strong>{{ item.weather.city }}</strong> on
                  <span>{{ item.weather.day }}</span> at
                  <span>{{ item.weather.time }}</span>, and the sky is
                  <strong>{{ item.weather.weather }}</strong>.
                </p>
              </div>
            {% endif %}

            {% if item.solution %}
              <span id="thinking-{{ forloop.counter }}" class="d-none">Thinking...</span>
              <div class="d-flex rounded shadow-sm mt-3" id="solution-{{ forloop.counter }}">
                <ul class="list-unstyled m-3">
                  <li class="list-group-item mb-3"><strong>Equation:</strong> <span class="ms-2 text-muted">{{ item.solution.equation }}</span></li>
                  <li class="list-group-item mb-3"><strong>Step 1:</strong> <span class="ms-2 text-muted">{{ item.solution.step1 }}</span></li>
                  <li class="list-group-item mb-3"><strong>Step 2:</strong> <span class="ms-2 text-muted">{{ item.solution.step2 }}</span></li>
                  <li class="list-group-item mb-3"><strong>Step 3:</strong> <span class="ms-2 text-muted" id="step3">\({{ item.solution.step3|safe }}\)</span></li>
                  {% if item.solution.step4 and item.solution.step5 %}
                    <li class="list-group-item mb-3"><strong>Step 4:</strong> <span class="ms-2 text-muted">{{ item.solution.step4 }}</span></li>
                    <li class="list-group-item mb-3"><strong>Step 5:</strong> <span class="ms-2 text-muted">{{ item.solution.step5 }}</span></li>
                  {% endif %}
                  <li class="list-group-item mb-3"><strong>Solution:</strong> <span class="ms-2 text-success badge bg-success">{{ item.solution.answer }}</span></li>
                  <li><p>{{ item.solution.message }}</p></li>
                  <li class="list-group-item"><img src="{{ item.solution.image_url }}" alt="Generated Image" style="max-width: 100%; height: 40vh; border-radius: 8px; margin-bottom: 10px;" /></li>
                </ul>
              </div>
            {% endif %}

            {% if item.disease_message %}
              <div class="d-flex rounded shadow-sm mt-3">
                <ul class="list-unstyled m-3 text-dark">
                  <li class="list-group-item text-muted m-2">Based on the symptoms provided: <strong>{{ item.disease_message.user_input }}</strong>. I believe you have <strong>{{ item.disease_message.predicted }}</strong>.</li>
                  <li class="list-group-item text-muted m-2"><strong>Description:</strong><br />{{ item.disease_message.description }}</li>
                  <li class="list-group-item text-muted m-2"><strong>Precautions:</strong><br />{{ item.disease_message.precaution }}</li>
                  <li class="list-group-item text-muted m-2"><strong>Disclaimer:</strong> This information is generated by ZackBird AI. Please consult a healthcare professional for a proper diagnosis and treatment plan.</li>
                </ul>
              </div>
              <hr />
            {% endif %}

            {% if item.fileData %}
              <div class="d-flex">
                <ul class="list-unstyled my-3">
                  {% if item.fileData.mainHeader %}
                    <li class="list-group-item-heading my-3"><strong class="text-muted">{{ item.fileData.mainHeader }}</strong></li>
                  {% endif %}
                  {% if item.fileData.title %}
                    <li class="list-group-item my-3">{{ item.fileData.title }}</li>
                  {% endif %}
                  {% if item.fileData.paragraph %}
                    {% for line in item.fileData.paragraph %}
                      <div>{{ line }}</div>
                    {% endfor %}
                  {% endif %}
                  {% if item.fileData.bullets %}
                    <li class="list-group-item my-3">
                      <ul>
                        {% for bullet in item.fileData.bullets %}
                          <li>{{ bullet }}</li>
                        {% endfor %}
                      </ul>
                    </li>
                  {% endif %}
                  {% if item.fileData.links %}
                    <li class="list-group-item my-3">
                      {% for link in item.fileData.links %}
                        <a href="{{ link.url }}" target="_blank" rel="noopener noreferrer">{{ link.text }}</a><br />
                      {% endfor %}
                    </li>
                  {% endif %}
                  {% if item.fileData.table %}
                    <li class="list-group-item my-3">
                      <table class="table table-bordered">
                        {% for row in item.fileData.table %}
                          <tr>
                            {% for cell in row %}
                              <td>{{ cell }}</td>
                            {% endfor %}
                          </tr>
                        {% endfor %}
                      </table>
                    </li>
                  {% endif %}
                  {% if item.fileData.message %}
                    <hr />
                    <li><strong>{{ item.fileData.message }}</strong></li>
                  {% endif %}
                </ul>
              </div>
              <hr />
            {% endif %}

            {% if item.image_url %}
              <img src="{{ item.image_url }}" alt="Generated Image" style="max-width: 100%; height: 40vh; border-radius: 8px; margin-bottom: 10px;" />
            {% endif %}

            {% if item.last_Data %}<p class="message_display">{{ item.last_Data }}</p>{% endif %}
            {% if item.label %}<p class="message_display">{{ item.label }}</p>{% endif %}
          </div>
        {% empty %}
          <p class="text-muted">No messages yet.</p>
        {% endfor %}

      </div>

      <!-- Message & Upload Form -->
      <form method="POST" id="form" enctype="multipart/form-data" action="{% url 'submit_message' %}" class="text-center d-grid" style="grid-template-columns: 60% 10% 20%; gap: 20px;">
        {% csrf_token %}

        <div id="button-group" class="input-group mb-3" style="margin: 10px; box-shadow: 6px 3px 3px 3px rgba(13, 5, 1, 0.1); background-color: azure; position: relative;">
          <textarea class="form-control" name="message" id="message" placeholder="Type your message here..." style="border-style: none; width: 100%; padding-right: 30px;"></textarea>
          <label id="file-upload-label" class="input-group-text" for="file-upload" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; background-color: transparent; border: none;">
            <i class="fa-solid fa-paperclip" id="onclick_icon" style="color: grey; font-size: 30px;"></i>
          </label>
        </div>

        <div id="upload_data" class="upload_data" style="justify-items: center; cursor: pointer; z-index: 100; width: 159px; border-radius: 10px; box-shadow: 4px 6px 7px rgba(255,255,44,0.3); background-color: rgba(211,211,211,0.8); margin: -120px -100px; height: 16vh;">
          <p id="label_upload">file</p>
          <p>image</p>
          <p>Draw</p>
        </div>

        <div class="mb-3">
          <button type="submit" id="button" class="btn btn-outline-primary" style="min-height: 50px; margin: 10px; border-radius: 0 10px 0 10px;">
            <i class="fa-solid fa-paper-plane"></i> submit
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- jQuery (optional), Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Per-card spinner simulation for website results
    document.addEventListener("DOMContentLoaded", function () {
      document.querySelectorAll('[id^="results-"]').forEach(function (resultsEl) {
        const id = resultsEl.id.split('-')[1];
        const spinner = document.getElementById('spinner-' + id);
        if (!spinner) return;
        spinner.classList.remove('d-none');
        resultsEl.classList.add('d-none');
        setTimeout(() => {
          spinner.classList.add('d-none');
          resultsEl.classList.remove('d-none');
        }, 2000);
      });
    });

    // Upload popover + fetch upload to Django view
    document.addEventListener("DOMContentLoaded", () => {
      const fileIcon = document.getElementById("onclick_icon");
      const fileData = document.getElementById("upload_data");
      const uploadLabel = document.getElementById("label_upload");
      const submitButton = document.getElementById("button");
      const container = document.querySelector(".main-container");

      const defaultText = "Submit";
      const uploadText = "Uploading...";
      const uploadDocument = "Upload";

      fileIcon.addEventListener("click", () => {
        fileData.style.display = fileData.style.display === "none" || fileData.style.display === "" ? "block" : "none";
      });

      uploadLabel.addEventListener("click", () => {
        const fileInput = document.createElement("input");
        fileInput.type = "file";
        fileInput.name = "upload_datafiles";
        fileInput.accept = "*/*";
        fileInput.style.display = "none";
        document.body.appendChild(fileInput);
        fileInput.click();

        fileInput.addEventListener("change", () => {
          if (fileInput.files.length > 0) {
            const send_file = fileInput.files[0];
            fileData.style.display = "none";
            submitButton.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> ${uploadText}`;

            const formData = new FormData();
            formData.append("file", send_file);

            fetch("{% url 'upload_datafiles' %}", {
              method: "POST",
              body: formData,
              headers: { "X-CSRFToken": getCSRFToken() },
            })
              .then((response) => response.json())
              .then((data) => {
                console.log("Success:", data);
                submitButton.innerHTML = `<i class="fa-solid fa-paper-plane"></i> ${uploadText}`;
              })
              .catch((error) => {
                console.error("Error:", error);
                submitButton.innerHTML = `<i class="fa-solid fa-paper-plane"></i> ${defaultText}`;
              });

            setTimeout(() => {
              submitButton.innerHTML = `<i class="fa-solid fa-paper-plane"></i> ${uploadDocument}`;
            }, 2000);
          } else {
            submitButton.innerHTML = `<i class="fa-solid fa-paper-plane"></i> ${defaultText}`;
          }
          document.body.removeChild(fileInput);
        });
      });

      function getCSRFToken() {
        const el = document.querySelector("[name=csrfmiddlewaretoken]");
        return el ? el.value : "";
      }

      // Scroll to bottom after form submit
      document.getElementById("form").addEventListener("submit", () => {
        setTimeout(() => { container.scrollTop = container.scrollHeight; }, 50);
      });

      // Also scroll when clicking submit immediately
      submitButton.addEventListener("click", () => {
        setTimeout(() => { container.scrollTop = container.scrollHeight; }, 200);
      });
    });

    // Clear messageData on reload (modern API)
    document.addEventListener("DOMContentLoaded", function () {
      const nav = performance.getEntriesByType('navigation')[0];
      if (nav && nav.type === 'reload') {
        fetch("{% url 'clear_message_data' %}", {
          method: "POST",
          headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/json",
          },
        })
          .then((response) => response.json())
          .then((data) => console.log("messageData cleared on refresh:", data))
          .catch((error) => console.error("Error clearing messageData:", error));
      }
    });
  </script>
</body>
</html>
